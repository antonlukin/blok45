apiVersion: v1
kind: ConfigMap
metadata:
  name: blok45-nginx
data:
  default.conf: |
    server {
      listen 80;
      server_name _;
      root /var/www/html;

      index index.php index.html;

      location / {
        try_files $uri $uri/ /index.php?$args;
      }

      location ~ \.php$ {
        try_files $uri =404;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS off;
        fastcgi_pass 127.0.0.1:9000;
      }

      location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
        expires 7d;
        access_log off;
      }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blok45
spec:
  replicas: 1
  selector:
    matchLabels:
      app: blok45
  template:
    metadata:
      labels:
        app: blok45
    spec:
      volumes:
        - name: wp
          emptyDir: {}
        - name: nginx-conf
          configMap:
            name: blok45-nginx

      initContainers:
        - name: wp-seed
          image: ghcr.io/antonlukin/blok45:latest
          imagePullPolicy: Always
          command: ["sh", "-lc"]
          args:
            - |
              set -e
              cp -a /usr/src/wordpress/. /work/
          volumeMounts:
            - name: wp
              mountPath: /work

      containers:
        - name: php-fpm
          image: ghcr.io/antonlukin/blok45:latest
          imagePullPolicy: Always
          env:
            - name: WORDPRESS_CONFIG_EXTRA
              value: |
                define('WP_HOME', 'https://dev.blok45.art');
                define('WP_SITEURL', 'https://dev.blok45.art');

                define('DISALLOW_FILE_EDIT', true);
                define('DISALLOW_FILE_MODS', true);
                define('UMAMI_WEBSITE_ID', '');

                if (getenv('S3_UPLOADS_REGION')) define('S3_UPLOADS_REGION', getenv('S3_UPLOADS_REGION'));
                if (getenv('S3_UPLOADS_BUCKET')) define('S3_UPLOADS_BUCKET', getenv('S3_UPLOADS_BUCKET'));
                if (getenv('S3_UPLOADS_BUCKET_URL')) define('S3_UPLOADS_BUCKET_URL', getenv('S3_UPLOADS_BUCKET_URL'));
                if (getenv('S3_UPLOADS_ENDPOINT')) define('S3_UPLOADS_ENDPOINT', getenv('S3_UPLOADS_ENDPOINT'));
                define('S3_UPLOADS_USE_PATH_STYLE_ENDPOINT', true);

                if (getenv('BLOK45_LOGIN_SLUG')) define('BLOK45_LOGIN_SLUG', getenv('BLOK45_LOGIN_SLUG'));
                if (getenv('BLOK45_LOGIN_REDIRECT_SLUG')) define('BLOK45_LOGIN_REDIRECT_SLUG', getenv('BLOK45_LOGIN_REDIRECT_SLUG'));
          envFrom:
            - secretRef:
                name: blok45-db
            - secretRef:
                name: blok45-wp-secrets
          ports:
            - containerPort: 9000
          volumeMounts:
            - name: wp
              mountPath: /var/www/html

        - name: nginx
          image: nginx:1.27-alpine
          ports:
            - containerPort: 80
          volumeMounts:
            - name: wp
              mountPath: /var/www/html
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf

---
apiVersion: v1
kind: Service
metadata:
  name: blok45
spec:
  selector:
    app: blok45
  ports:
    - name: http
      port: 80
      targetPort: 80

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: blok45
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - dev.blok45.art
      secretName: blok45-tls
  rules:
    - host: dev.blok45.art
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: blok45
                port:
                  number: 80
